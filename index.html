<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GraphTest</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.css">
</head>
<body style="padding-top: 40px">
<div class="container" style="margin-bottom: 25px;">
    <div class="notification is-success table">
        <div class="block">
            <h2 class="is-size-3">1. Ange dina l√•n</h2>
        </div>
        <div class="columns">
            <label class="column has-text-centered is-size-5" for="amount">L√•nebelopp </label>
            <label class="column has-text-centered is-size-5" for="rate">R√§ntesats (%)</label>
            <label class="column has-text-centered is-size-5" for="payoff">Amortering per m√•nad</label>
            <label class="column has-text-centered is-size-5" for="date">Villkors√§ndringsdatum</label>
            <label class="column has-text-centered is-size-5" for="addLoan"></label>
        </div>

        <form class="columns" id="a" onsubmit="addLoans(); return false;">
            <div class="column has-text-centered">
                <input type="number" class="input" form="a" placeholder="100000" name="amount" id="amount" required>
            </div>
            <div class="column has-text-centered">
                <input type="number" class="input" form="a" placeholder="2%" name="rate" id="rate" required>
            </div>
            <div class="column has-text-centered">
                <input type="number" class="input" form="a" placeholder="5000" name="payoff" id="payoff" required>
            </div>
            <div class="column has-text-centered">
                <input type="date" class="input" form="a" placeholder="2023-04-01" name="date" id="date" required>
            </div>
            <div class="column has-text-centered">
                <input type="submit" class="button" name="date" id="addLoan" value="L√§gg till">
            </div>
        </form>
    </div>
</div>

<div class="container" style="margin-bottom: 25px;">

    <div class="notification is-success">


        <div class="block">
            <h2 class="is-size-3">2. V√§lj data att visa</h2>
        </div>

        <div class="columns">
            <label class="column is-size-5">Prognos</label>
            <label class="column is-size-5">Datapunkt</label>
        </div>

        <div class="columns">
            <div id="forecasts" class="column control"></div>
            <div id="fields" class="column control"></div>
        </div>


    </div>
</div>


<div class="container">
    <div class="notification is-success">
        <div class="block">
            <h2 class="is-size-3">3. Tada!</h2>
        </div>
        <div class="chart-container container" style="position: relative">
            <canvas id="chart"></canvas>
        </div>
    </div>
</div>

<script>
    let theChart;
    const RATE_FORECASTS = [
        {
            description: "Str√§cker sig till 2025. R√§knar styrr√§nta + 1.5 %. https://www.regeringen.se/49e1d3/contentassets/ed453bf24f17472e95c31dd96bf3c5a3/presentationsbilder-fran-presstraff-med-mikael-damberg-den-22-juni-2022.pdf",
            name: "Finansdepartementet",
            forecast: [
                ["2022-01-01", '1.9 %'],
                ["2023-01-01", '2.79 %'],
                ["2024-01-01", '3.0 %'],
                ["2025-01-01", '3.0 %'],
                ["2026-01-01", '3.0 %'],
                ["2027-01-01", '3.0 %'],
                ["2028-01-01", '3.0 %'],
                ["2029-01-01", '3.0 %'],
                ["2030-01-01", '3.0 %'],
            ],

        },
        {
            description: "Str√§cker sig till 2026.",
            name: "SBAB",
            forecast: [
                ["2022-01-01", '1.8 %'],
                ["2023-01-01", '2.7 %'],
                ["2024-01-01", '3.5 %'],
                ["2025-01-01", '3.6 %'],
                ["2026-01-01", '3.7 %'],
                ["2027-01-01", '3.7 %'],
                ["2028-01-01", '3.7 %'],
                ["2029-01-01", '3.7 %'],
                ["2030-01-01", '3.7 %'],
            ],
        }
    ]

    let loans = [{
        "rates": [["2023-08-25", "2.26%"]],
        "repay": 1771,
        "amount": 902805
    }];

    const AMOUNT = 'Total l√•n';
    const RATE_PER_MONTH = 'R√§nta per m√•nad';
    const RATE_PER_MONTH_USING_BANK_RATE = 'R√§nta per m√•nad med bankens r√§nta';
    const RATE_DIFF = 'Besparing per m√•nad p.g.a. nuvarande bindningar';
    const RATE_AND_REPAY = 'R√§nta + amortering per m√•nad';
    const AVG_RATE = 'Min snittr√§nta';
    const BANK_RATE = 'Prognostiserad r√∂rliga r√§nta';

    const COLORS = ['red', 'blue', 'green', 'yellow', 'teal', 'magenta', 'cyan'];

    const butNice = (num) => num.toLocaleString('sv-SE').split(',')[0];
    const getPrintDays = () => {
        let printDays = [];
        let currentDate = new Date("2022-07-01")
        while (currentDate.toISOString() <= "2030-01-02") {
            printDays.push(currentDate.toISOString());
            currentDate = new Date(currentDate.setMonth(currentDate.getMonth() + 1));
        }

        return printDays.map(d => new Date(d));
    }

    const monthlyRateAtDate = (internalForecasts, loans, calcDate) => loans.reduce((acc, curr) => {
        return acc + ((curr.amount * getRate(internalForecasts, curr.rates, calcDate)) / 12)
    }, 0)

    const monthlyBankRateAtDate = (internalForecasts, loans, calcDate) => loans.reduce((acc, curr) => {
        return acc + ((curr.amount * getRate(internalForecasts, [], calcDate)) / 12)
    }, 0)

    const avgRateAtDate = (internalForecasts, loans, calcDate) => loans.reduce((acc, curr) => {
        return acc + getRate(internalForecasts, curr.rates, calcDate)
    }, 0) / loans.length

    const getLoanSize = (loans) => loans.reduce((acc, curr) => acc + curr.amount, 0)
    const getPayoffPerMonth = (loans) => loans.reduce((acc, curr) => acc + curr.repay, 0)

    const getRate = (internalForecasts, rates, date) => {
        const existingRate = rates.find(([end, _]) => end >= date.toISOString());
        if (existingRate) return parseFloat(existingRate[1]) / 100;

        const forecastRate = internalForecasts.find(([begin, _]) => begin <= date.toISOString());
        return parseFloat(forecastRate[1]) / 100;
    }

    function extracted(loans, internalForecasts, date) {
        return {
            [AMOUNT]: getLoanSize(loans),
            [RATE_PER_MONTH]: monthlyRateAtDate(internalForecasts, loans, date),
            [RATE_PER_MONTH_USING_BANK_RATE]: monthlyBankRateAtDate(internalForecasts, loans, date),
            [RATE_DIFF]: monthlyBankRateAtDate(internalForecasts, loans, date) - monthlyRateAtDate(internalForecasts, loans, date),
            [RATE_AND_REPAY]: getPayoffPerMonth(loans) + monthlyRateAtDate(internalForecasts, loans, date),
            [AVG_RATE]: avgRateAtDate(internalForecasts, loans, date),
            [BANK_RATE]: getRate(internalForecasts, [], date),
        };
    }

    const calculateRate = ({ loans, forecast, selector }) => {
        const internalLoans = [...loans];
        const internalForecasts = [...forecast].reverse();
        const dates = getPrintDays();
        let currentDate = new Date(Date.now());

        const fastForwardTo = (fastForwardToDate) => {
            while (currentDate.toISOString() < fastForwardToDate.toISOString()) {
                for (let i = 0; i < internalLoans.length; i++) {
                    internalLoans[i] = {
                        ...internalLoans[i],
                        amount: internalLoans[i].amount - internalLoans[i].repay
                    }
                }
                currentDate = new Date(currentDate.setMonth(currentDate.getMonth() + 1));
            }
        }

        return dates.reduce((table, date) => {
            fastForwardTo(date)
            table.push(extracted(internalLoans, internalForecasts, date)[selector]);
            return table;
        }, []);
    }

    const getChartJsResults = (results) => ({
        labels: getPrintDays().map(date => date.toISOString().split('T')[0]),
        datasets: results.map(({ label, data }, i) => ({
            label: label,
            data: data,
            backgroundColor: COLORS[i],
            borderColor: COLORS[i],
            borderWidth: 1
        }))
    })

    const renderData = () => {
        console.log('about to render');
        const ctx = document.getElementById('chart').getContext('2d');
        theChart && theChart.destroy && theChart.destroy();

        theChart = new Chart(ctx, {
            type: 'line',
            data: getChartJsResults([
                {
                    label: $("input[name='fieldselection']:checked").val(),
                    data: calculateRate({
                        loans,
                        forecast: RATE_FORECASTS.find(forecast => forecast.name === $("input[name='forecastselection']:checked").val()).forecast,
                        selector: $("input[name='fieldselection']:checked").val(),
                    })
                }
            ]),
            options: { scales: { y: { beginAtZero: true } } }
        });
    }
    const renderLoans = () => {
        $(".renderedLoan").remove()
        loans.map(({ rates, repay, amount }, i) => {

            $(".table").append($(
                `
                <div class="columns renderedLoan is-flex is-vcentered" style="border-bottom: 1px white solid">
                    <label class="column has-text-centered is-align-items-center">${butNice(amount)} kr</label>
                    <label class="column has-text-centered">${rates[0][1]}</label>
                    <label class="column has-text-centered">${butNice(repay)} kr</label>
                    <label class="column has-text-centered">${rates[0][0]}</label>
                    <div class="column has-text-centered">
                          <input type="button" class="button" name="removeLoan" id="removeLoan-${i}" value="üóëÔ∏è">
                    </div>
                </div>
            `
            ))

            $(`#removeLoan-${i}`).click(() => {
                loans.splice(i, 1)
                renderLoans();
                renderData();
            })
        });
    }

    const addLoans = () => {
        loans.push({
            rates: [[$("input[name='date']").val(), `${$("input[name='rate']").val()}%`]],
            repay: parseFloat($("input[name='payoff']").val()),
            amount: parseFloat($("input[name='amount']").val())

        })
        renderLoans();
        renderData();
    }

    $(document).ready(() => {
        const selects = {
            AMOUNT,
            RATE_PER_MONTH,
            RATE_PER_MONTH_USING_BANK_RATE,
            RATE_DIFF,
            RATE_AND_REPAY,
            AVG_RATE,
            BANK_RATE
        };

        Object.keys(selects).map((prop, i) => $("#fields").append($(
            `<label class="radio field-radios"> <input type="radio" id="fieldselection-${i}" name="fieldselection" value="${selects[prop]}"> ${selects[prop]} </label><br>`
        )));

        RATE_FORECASTS.map((forecast, i) => $("#forecasts").append($(
            `<label class="radio forecast-radios"> <input type="radio" id="forecastselection-${i}" name="forecastselection" value="${forecast.name}"> ${forecast.name} </label><br>`
        )));


        $(".field-radios").click(renderData);
        $(".forecast-radios").click(renderData);

        $('#fieldselection-1').attr('checked', 'checked');
        $('#forecastselection-0').attr('checked', 'checked');

        renderLoans();
        renderData();
    })
</script>
</body>
</html>
