<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GraphTest</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.css">
</head>
<body style="padding: 40px">
<div class="table" style="padding: 40px;min-height:30vh; min-width:60vw">

    <div class="columns">
        <label class="column" for="amount">Lånebelopp </label>
        <label class="column" for="rate">Räntesats (%)</label>
        <label class="column" for="payoff">Amortering per månad</label>
        <label class="column" for="date">Villkorsändringsdatum</label>
        <label class="column" for="addLoan"></label>
    </div>

    <div class="columns">
        <div class="field-amount column">
            <input type="number" class="input" placeholder="100000" name="amount" id="amount">
        </div>
        <div class="field-rate column">
            <input type="number" class="input" placeholder="2%" name="rate" id="rate">
        </div>
        <div class="field-payoff column">
            <input type="number" class="input" placeholder="5000" name="payoff" id="payoff">
        </div>
        <div class="field-date column">
            <input type="date" class="input" placeholder="2023-04-01" name="date" id="date">
        </div>
        <div class="field-date column">
            <input type="button" class="button" name="date" id="addLoan" value="Lägg till">
        </div>
    </div>
</div>

<div id="fields" class="control"></div>
<div class="chart-container" style="position: relative; height:30vh; width:60vw">
    <canvas id="chart"></canvas>
</div>
<script>
    let theChart;
    const RATE_FORECASTS = [
        {
            description: "Sträcker sig till 2025. Räknar styrränta + 1.5 %. https://www.regeringen.se/49e1d3/contentassets/ed453bf24f17472e95c31dd96bf3c5a3/presentationsbilder-fran-presstraff-med-mikael-damberg-den-22-juni-2022.pdf",
            name: "Finansdepartementet",
            forecast: [
                ["2022-01-01", '1.9 %'],
                ["2023-01-01", '2.79 %'],
                ["2024-01-01", '3.0 %'],
                ["2025-01-01", '3.0 %'],
                ["2026-01-01", '3.0 %'],
                ["2027-01-01", '3.0 %'],
                ["2028-01-01", '3.0 %'],
                ["2029-01-01", '3.0 %'],
                ["2030-01-01", '3.0 %'],
            ],

        },
        {
            description: "Sträcker sig till 2026.",
            name: "SBAB",
            forecast: [
                ["2022-01-01", '1.8 %'],
                ["2023-01-01", '2.7 %'],
                ["2024-01-01", '3.5 %'],
                ["2025-01-01", '3.6 %'],
                ["2026-01-01", '3.7 %'],
                ["2027-01-01", '3.7 %'],
                ["2028-01-01", '3.7 %'],
                ["2029-01-01", '3.7 %'],
                ["2030-01-01", '3.7 %'],
            ],
        }
    ]

    let loans = [];

    const AMOUNT = 'Total lån';
    const RATE_PER_MONTH = 'Ränta per månad';
    const RATE_PER_MONTH_USING_BANK_RATE = 'Ränta per månad med bankens ränta';
    const RATE_AND_REPAY = 'Inklusive amortering';
    const AVG_RATE = 'Min snittränta';
    const BANK_RATE = 'Bankens rörliga ränta';

    const COLORS = ['red', 'blue', 'green', 'yellow', 'teal', 'magenta', 'cyan'];

    const getPrintDays = () => {
        let printDays = [];
        let currentDate = new Date("2022-07-01")
        while (currentDate.toISOString() <= "2030-01-02") {
            printDays.push(currentDate.toISOString());
            currentDate = new Date(currentDate.setMonth(currentDate.getMonth() + 1));
        }

        return printDays.map(d => new Date(d));
    }

    const monthlyRateAtDate = (internalForecasts, loans, calcDate) => loans.reduce((acc, curr) => {
        return acc + ((curr.amount * getRate(internalForecasts, curr.rates, calcDate)) / 12)
    }, 0)

    const monthlyBankRateAtDate = (internalForecasts, loans, calcDate) => loans.reduce((acc, curr) => {
        return acc + ((curr.amount * getRate(internalForecasts, [], calcDate)) / 12)
    }, 0)

    const avgRateAtDate = (internalForecasts, loans, calcDate) => loans.reduce((acc, curr) => {
        return acc + getRate(internalForecasts, curr.rates, calcDate)
    }, 0) / loans.length

    const getLoanSize = (loans) => loans.reduce((acc, curr) => acc + curr.amount, 0)
    const getPayoffPerMonth = (loans) => loans.reduce((acc, curr) => acc + curr.repay, 0)

    const getRate = (internalForecasts, rates, date) => {
        const existingRate = rates.find(([end, _]) => end >= date.toISOString());
        if (existingRate) return parseFloat(existingRate[1]) / 100;

        const forecastRate = internalForecasts.find(([begin, _]) => begin <= date.toISOString());
        return parseFloat(forecastRate[1]) / 100;
    }

    function extracted(loans, internalForecasts, date) {
        return {
            [AMOUNT]: getLoanSize(loans),
            [RATE_PER_MONTH]: monthlyRateAtDate(internalForecasts, loans, date),
            [RATE_PER_MONTH_USING_BANK_RATE]: monthlyBankRateAtDate(internalForecasts, loans, date),
            [RATE_AND_REPAY]: getPayoffPerMonth(loans) + monthlyRateAtDate(internalForecasts, loans, date),
            [AVG_RATE]: avgRateAtDate(internalForecasts, loans, date),
            [BANK_RATE]: getRate(internalForecasts, [], date),
        };
    }

    const calculateRate = ({ loans, forecast, selector }) => {
        const internalLoans = [...loans];
        const internalForecasts = [...forecast].reverse();
        const dates = getPrintDays();
        let currentDate = new Date(Date.now());

        const fastForwardTo = (fastForwardToDate) => {
            while (currentDate.toISOString() < fastForwardToDate.toISOString()) {
                for (let i = 0; i < internalLoans.length; i++) {
                    internalLoans[i] = {
                        ...internalLoans[i],
                        amount: internalLoans[i].amount - internalLoans[i].repay
                    }
                }
                currentDate = new Date(currentDate.setMonth(currentDate.getMonth() + 1));
            }
        }

        return dates.reduce((table, date) => {
            fastForwardTo(date)
            table.push(extracted(internalLoans, internalForecasts, date)[selector]);
            return table;
        }, []);
    }


    const getChartJsResults = (results) => ({
        labels: getPrintDays().map(date => date.toISOString().split('T')[0]),
        datasets: results.map(({ label, data }, i) => ({
            label: label,
            data: data,
            backgroundColor: COLORS[i],
            borderColor: COLORS[i],
            borderWidth: 1
        }))
    })


    const renderData = () => {
        console.log('about to render');
        const ctx = document.getElementById('chart').getContext('2d');
        theChart && theChart.destroy && theChart.destroy();
        theChart = new Chart(ctx, {
            type: 'line',
            data: getChartJsResults([
                {
                    label: 'Template',
                    data: calculateRate({
                        loans,
                        forecast: RATE_FORECASTS[1].forecast,
                        selector: $("input[name='fieldselection']:checked").val(),
                    })
                }
            ]),
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    const renderLoans = () => {
        console.log('about to render loans');
        $(".renderedLoan").remove()
        loans.map(({ rates, repay, amount }, i) => {

            $(".table").append($(
                `
                <div class="columns renderedLoan">
                    <label class="column">${amount}</label>
                    <label class="column">${rates[0][1]}</label>
                    <label class="column">${repay}</label>
                    <label class="column">${rates[0][0]}</label>
                    <div class="column">
                          <input type="button" class="button" name="removeLoan" id="removeLoan-${i}" value="x">
                    </div>
                </div>
            `
            ))

            $(`#removeLoan-${i}`).click(() => {
                console.log(`removeLoan-${i}`)
                loans.splice(i, 1)
                renderLoans();
                renderData();
            })


        });
    }


    $(document).ready(function () {
        const selects = {
            AMOUNT: 'Total lån',
            RATE_PER_MONTH: 'Ränta per månad',
            RATE_PER_MONTH_USING_BANK_RATE: 'Ränta per månad med bankens ränta',
            RATE_AND_REPAY: 'Inklusive amortering',
            AVG_RATE: 'Min snittränta',
            BANK_RATE: 'Bankens rörliga ränta',
        }

        Object.keys(selects).map(prop => $("#fields").append($(
            `<label class="radio radiobtns"> <input type="radio" name="fieldselection" value="${selects[prop]}"> ${selects[prop]} </label><br>`
        )));
    });


    $(document).ready(() => {
            $(".radiobtns").click(renderData);

            $("#addLoan").click(() => {

                loans.push({
                    rates: [[$("input[name='date']").val(), `${$("input[name='rate']").val()}%`]],
                    repay: parseFloat($("input[name='payoff']").val()),
                    amount: parseFloat($("input[name='amount']").val())

                })
                renderLoans();
                renderData();
            });
        }
    )
</script>
</body>
</html>
